<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<head>

<title>SparkOstat</title>

<style type="text/css">
.style1 {
	border-width: 0;
}
.style2 {
	text-align: right;
}
.style3 {
	background-color: #C0C0C0;
}
.style4 {
	text-align: right;
	background-color: #C0C0C0;
}
.style5 {
	border-width: 0;
	background-color: #00FF00;
}
.style6 {
	border-style: solid;
	border-width: 1px;
	background-color: #C0C0C0;
}
</style>

<script type="text/javascript">
<!--

var loadingmessage = 'Processing...';
var Json, mode, autoMode, heatMode, fanMode, running, fan
var modes = new Array('Off', 'Cool', 'Heat', 'Auto')
var heatmodes = new Array('NG', 'HP', 'Auto')

function setAjax(){
   var xmlHttp;
   try{
      xmlHttp=new XMLHttpRequest(); // Firefox, Opera 8.0+, Safari
      return xmlHttp;
   }
   catch (e){
      try{
         xmlHttp=new ActiveXObject("Msxml2.XMLHTTP"); // Internet Explorer
         return xmlHttp;
      }
      catch (e){
         try{
            xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
            return xmlHttp;
         }
         catch (e){
            alert("Your browser does not support AJAX!");
            return false;
         }
     }
   }
}

function myAjax(f, myDivToChange) {
   var poststr = getFormValues(f);
//    postData(url, poststr, myDivToChange);
}

function readVar(varName){
   var xmlHttp = setAjax();
   xmlHttp.onreadystatechange =  function(){
      if(xmlHttp.readyState > 0 && xmlHttp.readyState < 4){
//          document.getElementById('myDivId').innerHTML=loadingmessage;
      }
      if (xmlHttp.readyState == 4) {
		var JsonObj = JSON.parse(xmlHttp.responseText)
//		document.getElementById('myDivId').innerHTML = JsonObj.result;
      }
   }
   url = 'https://api.spark.io/v1/devices/' + document.all.myDeviceId.value + '/' + varName + '?access_token=' + document.all.myToken.value
   xmlHttp.open("GET", url, false)
   xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
   xmlHttp.send();
   var myJsonObject = JSON.parse(xmlHttp.responseText)
   return myJsonObject.result
}

function getVar(varName){
   var xmlHttp = setAjax();
   xmlHttp.onreadystatechange =  function(){
      if(xmlHttp.readyState > 0 && xmlHttp.readyState < 4){
//		document.getElementById('myDivId').innerHTML=loadingmessage;
      }
      if (xmlHttp.readyState == 4) {
      	// this is where the magic occcurs
		var JsonObj = JSON.parse(xmlHttp.responseText)
//		document.getElementById('myDivId').innerHTML= JsonObj.return_value
      }
   }
   url = 'https://api.spark.io/v1/devices/' + document.all.myDeviceId.value + '/getvar?access_token=' + document.all.myToken.value
   xmlHttp.open("POST", url, false)
   xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
   xmlHttp.send( 'params=' + varName);
   var myJsonObject = JSON.parse(xmlHttp.responseText)
   return myJsonObject.return_value;
}

function setVar(varName, value){
   var xmlHttp = setAjax();
   xmlHttp.onreadystatechange =  function(){
      if(xmlHttp.readyState > 0 && xmlHttp.readyState < 4){
//		document.getElementById('myDivId').innerHTML=loadingmessage;
      }
      if (xmlHttp.readyState == 4) {
		// this is where the magic occcurs
		var myJsonObject = JSON.parse(xmlHttp.responseText)
//		document.getElementById('myDivId').innerHTML = myJsonObject.return_value
      }
   }
   url = 'https://api.spark.io/v1/devices/' + document.all.myDeviceId.value + '/setvar?access_token=' + document.all.myToken.value
   xmlHttp.open("POST", url, true)
   xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
   xmlHttp.send( 'params=' + varName + ',' + value)
}

function getAll()
{
 	settings = getVar('settings')
   	mode = settings & 3
	autoMode = (settings >> 2) & 3
	heatMode = (settings >> 4) & 3
	fanMode = (settings >> 6) & 1
	running = (settings>> 7) & 1
	fan = (settings>> 8) & 1
	ovrActive = (settings>> 9) & 1
//	eHeatThresh = (settings >> 10) & 0x3F
	document.all.fandelay.value = (settings >> 16) & 0xFF
	document.all.thresh.value = ((settings >> 24) & 0xFF) / 10

	document.all.fan.innerHTML = fan ? "Fan On" : "Fan Off"
	document.all.fanCell.setAttribute('class', fan ? 'style5' : 'style1');

	document.all.fanmode.innerHTML = fanMode ? "On" : "Auto"
	m = (mode == 4) ? autoMode : mode
	document.all.run.innerHTML = running ? modes[m] : "Idle"
	document.all.runCell.setAttribute('class', running ? 'style5' : 'style1');

	document.all.mode.innerHTML = modes[mode]
	document.all.heatmode.innerHTML = heatmodes[heatMode]

	res = readVar( 'result' )	// result set by settings call
	Json = JSON.parse(res)

	document.all.cooll.value = +Json.c0 / 10
	document.all.coolh.value = +Json.c1 / 10
	document.all.heatl.value = +Json.h0 / 10
	document.all.heath.value = +Json.h1 / 10
	document.all.intemp.innerHTML = +Json.it / 10
	document.all.target.innerHTML = +Json.tt / 10
	document.all.idlemin.value = +Json.im
	document.all.cycmin.value = +Json.cn
	document.all.cycmax.value = +Json.cx
//	document.all.filtermins.innerHTML = +Json.fh
	document.all.outtemp.innerHTML = +Json.ot / 10
//	outFL = +Json.ol
//	outFH = +Json.oh
	document.all.cyctimer.innerHTML = secsToTime( +Json.ct )
//	document.all.fantimer.innerHTML = +Json.ft
	document.all.runtotal.innerHTML = secsToTime( +Json.rt )
//	tempDiffTotal = +Json.td
	document.all.ovrtime.value = +Json.ov
	document.all.rh.innerHTML = +Json.rh / 10

	if( +document.all.ovrtemp.value == 0) // set a better default
		document.all.ovrtemp.value = -1.0
	document.all.ovrCell.setAttribute('class', ovrActive ? 'style5' : 'style1');
}

function togglefan()
{
	fanMode = !fanMode
	setVar('fanmode', fanMode ? 1:0)
	document.all.fanmode.innerHTML = fanMode ? "On" : "Auto"
	document.all.fan.innerHTML = "Fan " + (fanMode ? "On" : (fan ? "Off":"On"))
	document.all.fanCell.setAttribute('class', fan ? 'style5' : 'style1');
}

function setMode(m)
{
	mode = m
	setVar('mode', mode)
	document.all.mode.innerHTML = modes[mode]
}

function setHeatMode(m)
{
	heatMode = m
	setVar('heatmode', heatMode)
	document.all.heatmode.innerHTML = heatmodes[heatMode]
}

function setCoolHi()
{
	setVar('cooltemph', (+document.all.coolh.value * 10).toFixed() )
}

function setCoolLo()
{
	setVar('cooltempl', (+document.all.cooll.value * 10).toFixed() )
}

function incCool(n)
{
	document.all.coolh.value = +document.all.coolh.value + n
	document.all.cooll.value = +document.all.cooll.value + n

	setVar('cooltemph', (+document.all.coolh.value * 10).toFixed() )
	setVar('cooltempl', (+document.all.cooll.value * 10).toFixed() )
}

function setHeatHi()
{
	setVar('heattempl', (+document.all.heath.value * 10).toFixed() )
}

function setHeatLo()
{
	setVar('heattempl', (+document.all.heatl.value * 10).toFixed() )
}

function incHeat(n)
{
	document.all.heath.value = +document.all.heath.value + n
	document.all.heatl.value = +document.all.heatl.value + n

	setVar('heattemph', (+document.all.heath.value * 10).toFixed() )
	setVar('heattempl', (+document.all.heatl.value * 10).toFixed() )
}

function setThresh()
{
	setVar('cyclethresh', (+document.all.thresh.value * 10).toFixed() )
}

function setFeanDelay()
{
	setVar('fanpostdelay', +document.all.fandelay.value)
}

function setIdleMin()
{
	setVar('idlemin', document.all.idlemin.value)
}

function setCycMin()
{
	setVar('cyclemin', document.all.cycmin.value)
}

function setCycMax()
{
	setVar('cyclemax', document.all.cycmax.value)
}

function setOvrTime()
{
	setVar('overridetime', document.all.ovrtime.value)
}

function setOvrTemp()
{
	setVar('override', (+document.all.ovrtemp.value *10).toFixed() )
}

function cancelOvr()
{
	setVar('override', 0)
}

function secsToTime( elap )
{
	d = 0
	m = 0
	h   = Math.floor(elap / 3600)
	if(h >23)
	{
		d = Math.floor(h / 24)
		h -= (d*24)
	}
	else
	{
		m = Math.floor((elap - (h * 3600)) / 60)
		s = elap - (h * 3600) - (m * 60)
		if( s < 10) s = '0' + s
		if(h == 0)
		{
			if( m < 10) m = '  ' + m
			return '    ' + m +':'+s
		}
	}
	if( m < 10) m = '0' + m
	if( h < 10) h = '  ' + h
	if(d) return d + 'd ' + h + 'h'
	return h+':'+m+':'+s
}

//--></script>

</head>
<body onload="{
  myStorage1 = localStorage.getItem('myStoredText1')
  if(myStorage1  != null){
	document.all.myToken.style.visibility = 'hidden'  // hide sensitive data. remove these if irritating
	document.all.myDeviceId.style.visibility = 'hidden'
	document.getElementById('myToken').value = myStorage1
  }
    
  myStorage2 = localStorage.getItem('myStoredText2')
  if(myStorage2  != null){
	document.getElementById('myDeviceId').value = myStorage2
	getAll()
  }   
  myStorage3 = localStorage.getItem('myStoredText3')
  if(myStorage3  != null){
	document.getElementById('ovrtemp').value = myStorage3
  }
}">
<strong><em>CuriousTech SparkOstat Remote</em></strong><br>
<table style="width: 320px">
	<tr>
		<td style="width: 70px">Device</td>
		<td>
<input id="myDeviceId" name="myCoreID" type=text size=50 placeholder="78dd12345678123456" style="width: 265px"></td>
	</tr>
	<tr>
		<td style="width: 70px">Token</td>
		<td>
<input id="myToken" name="access_token" type=text size=50 placeholder="5622ce6bba702ef6bd3456d5ed26aaa4a28d7c9" style="width: 265px"></td>
	</tr>
</table>
<input type="button" value="Store ID and Token" onClick="{
   localStorage.setItem('myStoredText1', document.all.myToken.value)
   localStorage.setItem('myStoredText2', document.all.myDeviceId.value)
   alert( +document.all.myDeviceId.value + ' ' + document.all.myToken.value + ' \nHas been stored')
}">
<input type="button" value="Hide"  onClick="{
    document.all.myToken.style.visibility = 'hidden'
    document.all.myDeviceId.style.visibility = 'hidden'
}">
<input type="button" value="Show" style="background-color:lime" onClick="{
    document.all.myToken.style.visibility = 'visible'
    document.all.myDeviceId.style.visibility = 'visible'
}">
<input type="button" value="Refresh" onClick="{getAll()}">
<br>
<br>
<table style="width: 360px; height: 22px;" cellspacing="0">
	<tr>
		<td class="style3">In</td>
		<td class="style4"><div name="intemp" id="intemp" class="style2">in</div></td>
		<td class="style3">&deg</td>
		<td class="style3">Trg</td>
		<td class="style4"><div name="target" id="target" class="style2">trg</div></td>
		<td class="style3">&deg</td>
		<td class="style4"><div name="rh" id="rh" class="style2">rh</div></td>
		<td class="style3">%</td>
		<td class="style3">Out</td>
		<td class="style4"><div name="outtemp" id="outtemp" class="style2">out</div></td>
		<td class="style3">&deg</td>
	</tr>
</table>
<br>
<table style="width: 360px" class="style6" cellspacing="1" cellpadding="0">
	<tr>
		<td style="width: 81px" id="fanCell" class="style1"><div name="fan1" id="fan">Fan Off</div></td>
		<td style="width: 44px" class="style1"><div name="fan" id="fanmode">Auto</div></td>
		<td style="width: 200px" class="style1"><input type="button" value="Toggle" onClick="{togglefan()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" id="runCell" class="style1">Run</td>
		<td style="width: 44px" class="style1"><div name="run" id="run">off</div></td>
		<td style="width: 244px" class="style1">
		&nbsp;</td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Mode</td>
		<td style="width: 44px" class="style1"><div name="mode" id="mode">off</div></td>
		<td style="width: 200px" class="style1">
		<input type="button" value="Off" onClick="{setMode(0)}">
		<input type="button" value="Cool" onClick="{setMode(1)}">
		<input type="button" value="Heat" onClick="{setMode(2)}">
		<input type="button" value="Auto" onClick="{setMode(3)}">
		</td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">HeatMode</td>
		<td style="width: 44px" class="style1"><div name="heatmode" id="heatmode">Gas</div></td>
		<td style="width: 200px" class="style1">
		<input type="button" value="Gas" onClick="{setHeatMode(0)}">
		<input type="button" value="Elec" onClick="{setHeatMode(1)}">
		<input type="button" value="Auto" onClick="{setHeatMode(2)}">
		</td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Cool Hi</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="coolh"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setCoolHi()}"><input type="button" value="+1" onClick="{incCool(1)}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Cool Lo</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="cooll"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setCoolLo()}"><input type="button" value="-1" onClick="{incCool(-1)}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Heat Hi</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="heath"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setHeatHi()}"><input type="button" value="+1" onClick="{incHeat(1)}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Heat Lo</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="heatl"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setHeatLo()}"><input type="button" value="-1" onClick="{incHeat(-1)}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Threshold</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="thresh"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setThresh()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Fan Delay</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="fandelay"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setFanDelay()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">Idle Min</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="idlemin"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setIdleMin()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">cycle Min</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="cycmin"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setCycMin()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">cycleMax</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="cycmax"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setCycMax()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" class="style1">ovr Time</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="ovrtime"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Set" onClick="{setOvrTime()}"></td>
	</tr>
	<tr>
		<td style="width: 81px" id="ovrCell" class="style1">ovrTemp</td>
		<td style="width: 44px" class="style1"><input type=text size=5 value=0 id="ovrtemp"></td>
		<td style="width: 200px" class="style1"><input type="button" value="Start" onClick="{
		localStorage.setItem('myStoredText3', document.all.ovrtemp.value)
		setOvrTemp()}">
		<input type="button" value="Cancel" onClick="{cancelOvr()}">
		</td>
	</tr>
</table>

<br>
<table style="width: 360px">
	<tr>
		<td style="width: 80px" class="style3">Cycle</td>
		<td style="width: 147px" class="style3">
		<div name="cyctimer" id="cyctimer" style="width: 87px">cycle</div></td>
		<td style="width: 81px" class="style3">Total</td>
		<td class="style3"><div name="runtotal" id="runtotal">total</div></td>
	</tr>
</table>
<br>
<input type="button" value="Poll" onClick="{
    if(document.all.myPoll.value < 5){document.all.myPoll.value = 5}
    getAll()
    clearInterval(document.myPollSave)
    document.myPollSave = setInterval('getAll();',document.all.myPoll.value*1000)
}">
every <input type=text size=5 value=20 id="myPoll">Seconds

<input type="button" value="Stop" onClick="{
    clearInterval(document.myPollSave)
}">
</body>
</html>
