<html>
<head>

<title>SparkOstat</title>

<style type="text/css">
.style1 {
	border: 1px solid #000000;
}
</style>

<script type="text/javascript">
<!--

var loadingmessage = 'Processing...';
var Json, mode, autoMode, heatMode, fanMode, running, fan
var modes = new Array('Off', 'Cool', 'Heat', 'Auto')
var heatmodes = new Array('NG', 'HP', 'Auto')

function setAjax(){
   var xmlHttp;
   try{
      xmlHttp=new XMLHttpRequest(); // Firefox, Opera 8.0+, Safari
      return xmlHttp;
   }
   catch (e){
      try{
         xmlHttp=new ActiveXObject("Msxml2.XMLHTTP"); // Internet Explorer
         return xmlHttp;
      }
      catch (e){
         try{
            xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
            return xmlHttp;
         }
         catch (e){
            alert("Your browser does not support AJAX!");
            return false;
         }
     }
   }
}

function myAjax(f, myDivToChange) {
   var poststr = getFormValues(f);
//    postData(url, poststr, myDivToChange);
}

function readVar(varName){
   var xmlHttp = setAjax();
   xmlHttp.onreadystatechange =  function(){
      if(xmlHttp.readyState > 0 && xmlHttp.readyState < 4){
          document.getElementById('myDivId').innerHTML=loadingmessage;
      }
      if (xmlHttp.readyState == 4) {
		var JsonObj = JSON.parse(xmlHttp.responseText)
		document.getElementById('myDivId').innerHTML = JsonObj.result;
      }
   }
   url = 'https://api.spark.io/v1/devices/' + document.all.myDeviceId.value + '/' + varName + '?access_token=' + document.all.myToken.value
   xmlHttp.open("GET", url, false)
   xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
   xmlHttp.send();
   var myJsonObject = JSON.parse(xmlHttp.responseText)
   return myJsonObject.result
}

function getVar(varName){
   var xmlHttp = setAjax();
   xmlHttp.onreadystatechange =  function(){
      if(xmlHttp.readyState > 0 && xmlHttp.readyState < 4){
          document.getElementById('myDivId').innerHTML=loadingmessage;
      }
      if (xmlHttp.readyState == 4) {
             // this is where the magic occcurs
             
          var JsonObj = JSON.parse(xmlHttp.responseText)
          document.getElementById('myDivId').innerHTML= JsonObj.return_value
      }
   }
   url = 'https://api.spark.io/v1/devices/' + document.all.myDeviceId.value + '/getvar?access_token=' + document.all.myToken.value
   xmlHttp.open("POST", url, false)
   xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
   xmlHttp.send( 'params=' + varName);
   var myJsonObject = JSON.parse(xmlHttp.responseText)
   return myJsonObject.return_value;
}

function setVar(varName, value){
   var xmlHttp = setAjax();
   xmlHttp.onreadystatechange =  function(){
      if(xmlHttp.readyState > 0 && xmlHttp.readyState < 4){
          document.getElementById('myDivId').innerHTML=loadingmessage;
      }
      if (xmlHttp.readyState == 4) {
             // this is where the magic occcurs
             
		var myJsonObject = JSON.parse(xmlHttp.responseText)
		document.getElementById('myDivId').innerHTML = myJsonObject.return_value
      }
   }
   url = 'https://api.spark.io/v1/devices/' + document.all.myDeviceId.value + '/setvar?access_token=' + document.all.myToken.value
   xmlHttp.open("POST", url, true)
   xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
   xmlHttp.send( 'params=' + varName + ',' + value)
}

function getAll()
{
	stat = new Array('Cooling', 'Heating', 'eHeating')

 	settings = getVar('settings')
   	mode = settings & 3
	autoMode = (settings >> 2) & 3
	heatMode = (settings >> 4) & 3
	fanMode = (settings >> 6) & 1
	running = (settings>> 7) & 1
	fan = (settings>> 8) & 1
//	eHeatThresh = (settings >> 10) & 0x3F
	document.getElementById('fandelay').value = (settings >> 16) & 0xFF
	document.getElementById('thresh').value = ((settings >> 24) & 0xFF) / 10

	document.getElementById('fan').innerHTML = fan ? "On" : "Auto"
	document.getElementById('run').innerHTML = running ? stat[mode] : "Off"
	document.getElementById('mode').innerHTML = modes[mode]
	document.getElementById('heatmode').innerHTML = heatmodes[heatMode]


	res = readVar( 'result' )	// result set by settings call
	Json = JSON.parse(res)

	document.getElementById('cooll').value = +Json.c0 / 10
	document.getElementById('coolh').value = +Json.c1 / 10
	document.getElementById('heatl').value = +Json.h0 / 10
	document.getElementById('heath').value = +Json.h1 / 10
	document.getElementById('intemp').innerHTML = +Json.it / 10
	document.getElementById('target').innerHTML = +Json.tt / 10
	document.getElementById('idlemin').value = +Json.im
	document.getElementById('cycmin').value = +Json.cn
	document.getElementById('cycmax').value = +Json.cx
//	document.getElementById('filterhours').innerHTML = +Json.fh
	document.getElementById('outtemp').innerHTML = +Json.ot / 10
//	outFL = +Json.ol
//	outFH = +Json.oh
	document.getElementById('cyctimer').innerHTML = secsToTime( +Json.ct )
//	document.getElementById('fantimer').innerHTML = +Json.ft
	document.getElementById('runtotal').innerHTML = secsToTime( +Json.rt )
//	tempDiffTotal = +Json.td
	document.getElementById('ovrtime').value = +Json.ov
	document.getElementById('rh').innerHTML = +Json.rh / 10
}

function togglefan()
{
	fan = !fan
	setVar('fanmode', fan ? 1:0)
	document.getElementById('fan').innerHTML = fan ? "On" : "Auto"
}

function setMode(m)
{
	mode = m
	setVar('mode', mode)
	document.getElementById('mode').innerHTML = modes[mode]
}

function setHeatMode(m)
{
	heatMode = m
	setVar('heatmode', heatMode)
	document.getElementById('heatmode').innerHTML = heatmodes[heatMode]
}

function setCoolHi()
{
	setVar('cooltemph', (+document.getElementById('coolh').value * 10).toFixed() )
}

function setCoolLo()
{
	setVar('cooltempl', (+document.getElementById('cooll').value * 10).toFixed() )
}

function setHeatHi()
{
	setVar('heattempl', (+document.getElementById('heath').value * 10).toFixed() )
}

function setHeatLo()
{
	setVar('heattempl', (+document.getElementById('heatl').value * 10).toFixed() )
}

function setThresh()
{
	setVar('cyclethresh', (+document.getElementById('thresh').value * 10).toFixed() )
}

function setFeanDelay()
{
	setVar('fanpostdelay', +document.getElementById('fandelay').value)
}

function setIdleMin()
{
	setVar('idlemin', document.getElementById('idlemin').value)
}

function setCycMin()
{
	setVar('cyclemin', document.getElementById('cycmin').value)
}

function setCycMax()
{
	setVar('cyclemax', document.getElementById('cycmax').value)
}

function setOvrTime()
{
	setVar('overridetime', document.getElementById('ovrtime').value)
}

function setOvrTemp()
{
	setVar('override', (+document.getElementById('ovrtemp').value *10).toFixed() )
}

function secsToTime( elap )
{
	d = 0
	m = 0
	h   = Math.floor(elap / 3600)
	if(h >23)
	{
		d = Math.floor(h / 24)
		h -= (d*24)
	}
	else
	{
		m = Math.floor((elap - (h * 3600)) / 60)
		s = elap - (h * 3600) - (m * 60)
		if( s < 10) s = '0' + s
		if(h == 0)
		{
			if( m < 10) m = '  ' + m
			return '    ' + m +':'+s
		}
	}
	if( m < 10) m = '0' + m
	if( h < 10) h = '  ' + h
	if(d) return d + 'd ' + h + 'h'
	return h+':'+m+':'+s
}

//--></script>

</head>

<body onload="{
   myStorage1 = localStorage.getItem('myStoredText1')
   if(myStorage1  != null){
      document.all.myToken.style.visibility = 'hidden'  // hide sensitive data. remove these if irritating
      document.all.myDeviceId.style.visibility = 'hidden'
      document.getElementById('myToken').value = myStorage1 
    }
    
    myStorage2 = localStorage.getItem('myStoredText2')
    if(myStorage2  != null){
       document.getElementById('myDeviceId').value = myStorage2  
    }   
}">
<strong><em>CuriousTech SparkOstat Remote</em></strong><br>
<br>
Device ID:&nbsp;&nbsp;&nbsp;&nbsp; <input id="myDeviceId" name="myCoreID" type=text size=50 placeholder="78dd12345678123456"><br>
Access Token:<input id="myToken" name="access_token" type=text size=50 placeholder="5622ce6bba702ef6bd3456d5ed26aaa4a28d7c9"><br>
<br>
<input type="button" value="Store ID and Token" onClick="{
   localStorage.setItem('myStoredText1', document.all.myToken.value)   
   localStorage.setItem('myStoredText2', document.all.myDeviceId.value)
   alert( +document.all.myDeviceId.value + ' ' + document.all.myToken.value + ' \nHas been stored')
}">
<input type="button" value="Hide"  onClick="{
    document.all.myToken.style.visibility = 'hidden'
    document.all.myDeviceId.style.visibility = 'hidden'
}">
<input type="button" value="Show" style="background-color:lime" onClick="{
    document.all.myToken.style.visibility = 'visible'
    document.all.myDeviceId.style.visibility = 'visible'
}">
<input type="button" value="Refresh" onClick="{getAll()}">

<table style="width: 400px; height: 22px;">
	<tr>
		<td style="width: 100px">In</td>
		<td style="width: 100px"><div name="intemp" id="intemp" style="width: 77px">in</div></td>
		<td style="width: 100px">Trg</td>
		<td style="width: 100px"><div name="target" id="target">trg</div></td>
		<td style="width: 100px"><div name="rh" id="rh">rh</div></td>
		<td style="width: 100px">Out</td>
		<td style="width: 100px"><div name="outtemp" id="outtemp">out</div></td>
	</tr>
</table>
<br>
<table style="width: 400px" class="style1">
	<tr>
		<td style="width: 66px" class="style1">Fan</td>
		<td style="width: 50px" class="style1"><div name="fan" id="fan">off</div></td>
		<td style="width: 104px" class="style1"><input type="button" value="Toggle" onClick="{togglefan()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Run</td>
		<td style="width: 50px" class="style1"><div name="run" id="run">off</div></td>
		<td style="width: 244px" class="style1">
		&nbsp;</td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Mode</td>
		<td style="width: 50px" class="style1"><div name="mode" id="mode">off</div></td>
		<td style="width: 244px" class="style1">
		<input type="button" value="Off" onClick="{setMode(0)}">
		<input type="button" value="Cool" onClick="{setMode(1)}">
		<input type="button" value="Heat" onClick="{setMode(2)}">
		<input type="button" value="Auto" onClick="{setMode(3)}">
		</td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">HeatMode</td>
		<td style="width: 50px" class="style1"><div name="heatmode" id="heatmode">Gas</div></td>
		<td style="width: 244px" class="style1">
		<input type="button" value="Gas" onClick="{setHeatMode(0)}">
		<input type="button" value="Elec" onClick="{setHeatMode(1)}">
		<input type="button" value="Auto" onClick="{setHeatMode(2)}">
		</td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Cool Hi</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="coolh"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setCoolHi()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Cool Lo</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="cooll"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setCoolLo()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Heat Hi</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="heath"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setHeatHi()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Heat Lo</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="heatl"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setHeatLo()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Threshold</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="thresh"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setThresh()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Fan Delay</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="fandelay"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setFanDelay()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">Idle Min</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="idlemin"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setIdleMin()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">cycle Min</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="cycmin"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setCycMin()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">cycleMax</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="cycmax"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setCycMax()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">ovr Time</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="ovrtime"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Set" onClick="{setOvrTime()}"></td>
	</tr>
	<tr>
		<td style="width: 66px" class="style1">ovrTemp</td>
		<td style="width: 50px" class="style1"><input type=text size=5 value=0 id="ovrtemp"></td>
		<td style="width: 104px" class="style1"><input type="button" value="Start" onClick="{setOvrTemp()}"></td>
	</tr>
</table>

<br>
<table style="width: 400px">
	<tr>
		<td style="width: 80px">Cycle</td>
		<td style="width: 185px">
		<div name="cyctimer" id="cyctimer" style="width: 87px">cycle</div></td>
		<td style="width: 81px">Total</td>
		<td><div name="runtotal" id="runtotal">total</div></td>
	</tr>
</table>
<br>
<br>

<input type="button" value="Poll" onClick="{
    if(document.all.myPoll.value < '5'){document.all.myPoll.value = 5}
    getAll()
    clearInterval(document.myPollSave)
    document.myPollSave = setInterval('getAll()',document.all.myPoll.value*1000)
}">
every <input type=text size=5 value=20 id="myPoll">Seconds

<input type="button" value="Stop" onClick="{
    clearInterval(document.myPollSave)
}">

<br><br>

JSON response:<br>
<div width="400" height="200" name="myDivName" id="myDivId"> ............................................................................................................................... </div><br>
</body>
</html>
